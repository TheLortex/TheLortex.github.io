<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.9.0"/><meta charSet="utf-8" data-gatsby-head="true"/><meta name="viewport" content="width=device-width, initial-scale=1" data-gatsby-head="true"/><meta name="author" content="Lucas Pluvinage" data-gatsby-head="true"/><meta name="description" content="Lucas Pluvinage&#x27;s website" data-gatsby-head="true"/><meta name="keywords" content="" data-gatsby-head="true"/><style data-href="/styles.2fc987ab99476a778f24.css" data-identity="gatsby-global-css">@font-face{font-named-instance:"Light";font-display:swap;font-family:Lato;font-style:normal;font-weight:300;src:url(/fonts/Lato-Light.ttf) format("truetype")}@font-face{font-named-instance:"Regular";font-display:swap;font-family:Lato;font-style:normal;font-weight:400;src:url(/fonts/Lato-Regular.ttf) format("truetype")}@font-face{font-named-instance:"Bold";font-display:swap;font-family:Lato;font-style:normal;font-weight:700;src:url(/fonts/Lato-Bold.ttf) format("truetype")}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=53aa06cf17e4239d0dba6ffd09854e02" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><style data-emotion="css-global 109rmrq" data-gatsby-head="true">html{--theme-ui-colors-text:#333;--theme-ui-colors-background:#f8f8ff;--theme-ui-colors-primary:#ff9f29;--theme-ui-colors-secondary:#51697B;--theme-ui-colors-muted:#f6f6f6;color:var(--theme-ui-colors-text);background-color:var(--theme-ui-colors-background);}</style><style data-emotion="css-global dleq8w" data-gatsby-head="true">*{box-sizing:border-box;}html{font-family:Lato;line-height:1.625;font-weight:400;}body{margin:0;}</style><title data-gatsby-head="true">Lucas Pluvinage - Mirage on embedded devices: where are we?</title><link rel="icon" href="/static/favicon-ba1419b983b3bccb202cb22b00fe921f.ico" data-gatsby-head="true"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.documentElement.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion="css-global 109rmrq">html{--theme-ui-colors-text:#333;--theme-ui-colors-background:#f8f8ff;--theme-ui-colors-primary:#ff9f29;--theme-ui-colors-secondary:#51697B;--theme-ui-colors-muted:#f6f6f6;color:var(--theme-ui-colors-text);background-color:var(--theme-ui-colors-background);}</style><style data-emotion="css-global dleq8w">*{box-sizing:border-box;}html{font-family:Lato;line-height:1.625;font-weight:400;}body{margin:0;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion="css mhypsu">.css-mhypsu{padding-left:16px;padding-right:16px;padding-top:8px;padding-bottom:32px;}@media screen and (min-width: 40em){.css-mhypsu{padding-left:32px;padding-right:32px;}}.css-mhypsu a{color:var(--theme-ui-colors-secondary);}</style><main class="css-mhypsu"><style data-emotion="css nqlwoc">.css-nqlwoc{max-width:80ch;margin:auto;}</style><nav class="css-nqlwoc"><style data-emotion="css 1u5jjkp">.css-1u5jjkp{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding:0;}</style><ul class="css-1u5jjkp"><style data-emotion="css x4n4mc">.css-x4n4mc{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}</style><li class="css-x4n4mc"><style data-emotion="css ijnf57">.css-ijnf57{padding-top:64px;}</style><div class="css-ijnf57"><style data-emotion="css 1b6s52i">.css-1b6s52i{-webkit-transform:rotate(-30deg);-moz-transform:rotate(-30deg);-ms-transform:rotate(-30deg);transform:rotate(-30deg);width:50px;transform-origin:top left;padding:4px;font-size:24px;}@media screen and (min-width: 40em){.css-1b6s52i{width:100px;}}</style><div class="css-1b6s52i"><style data-emotion="css 1hpv60u">.css-1hpv60u{-webkit-text-decoration:none;text-decoration:none;color:var(--theme-ui-colors-secondary);}.css-1hpv60u:hover{-webkit-text-decoration:underline;text-decoration:underline;}.css-1hpv60u::after{display:block;content:attr(title);font-weight:700;height:0px;overflow:hidden;visibility:hidden;}</style><a title="home" class="css-1hpv60u" href="/">home</a></div></div><style data-emotion="css 1d8reql">.css-1d8reql{-webkit-align-self:stretch;-ms-flex-item-align:stretch;align-self:stretch;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;}</style><div class="css-1d8reql"><style data-emotion="css 1391gw0">.css-1391gw0{background-color:var(--theme-ui-colors-primary);border-radius:100%;width:24px;height:24px;position:absolute;top:-6px;left:-6px;}</style><div class="css-1391gw0"></div><style data-emotion="css 1ohyuec">.css-1ohyuec{background-color:var(--theme-ui-colors-primary);-webkit-flex:1;-ms-flex:1;flex:1;height:12px;}</style><div class="css-1ohyuec"></div></div></li><li class="css-x4n4mc"><div class="css-ijnf57"><div class="css-1b6s52i"><a title="projects" class="css-1hpv60u" href="/projects/">projects</a></div></div><div class="css-1d8reql"><div class="css-1391gw0"></div><div class="css-1ohyuec"></div></div></li><li class="css-x4n4mc"><div class="css-ijnf57"><div class="css-1b6s52i"><a title="articles" class="css-1hpv60u" href="/articles/">articles</a></div></div><div class="css-1d8reql"><style data-emotion="css wxtter">.css-wxtter{background-color:white;border:4px black solid;border-radius:100%;width:24px;height:24px;position:absolute;z-index:1000;top:-6px;left:-6px;}</style><div class="css-wxtter"></div><div class="css-1ohyuec"></div></div><style data-emotion="css wvopc1">.css-wvopc1{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;}</style><div class="css-wvopc1"><style data-emotion="css 113tkru">.css-113tkru{background-color:#FC4F00;margin-left:4px;margin-top:-4px;height:40px;width:40px;-webkit-clip-path:polygon(0% 0%, 8px 0%, 100% 32px, 100% 100%, 32px 100%, 0% 8px);clip-path:polygon(0% 0%, 8px 0%, 100% 32px, 100% 100%, 32px 100%, 0% 8px);}</style><div class="css-113tkru"></div><style data-emotion="css l5xv05">.css-l5xv05{position:relative;}</style><div class="css-l5xv05"><style data-emotion="css sba7cb">.css-sba7cb{position:absolute;width:1000px;bottom:6px;left:-4px;}</style><div class="css-sba7cb"><style data-emotion="css vcqf7v">.css-vcqf7v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;gap:16px;height:0;}</style><div class="css-vcqf7v"><style data-emotion="css rcsbs7">.css-rcsbs7{width:40px;border-bottom:solid 12px #FC4F00;box-sizing:border-box;border-bottom-right-radius:100px;border-top-right-radius:100px;position:relative;}</style><div class="css-rcsbs7"><style data-emotion="css 1hgbd7r">.css-1hgbd7r{background-color:#FC4F00;border-radius:100%;width:24px;height:24px;position:absolute;top:-6px;right:-6px;}</style><div class="css-1hgbd7r"></div></div><style data-emotion="css jkw5sz">.css-jkw5sz{margin:0;-webkit-text-decoration:underline;text-decoration:underline;color:var(--theme-ui-colors-secondary);}</style><h2 class="css-jkw5sz">Mirage on embedded devices: where are we?</h2></div></div></div></div></li><li class="css-x4n4mc"><div class="css-ijnf57"><div class="css-1b6s52i"><a title="photography" class="css-1hpv60u" href="/photography/">photography</a></div></div><div class="css-1d8reql"><div class="css-1391gw0"></div><style data-emotion="css 8pjec1">.css-8pjec1{-webkit-flex:1;-ms-flex:1;flex:1;height:12px;}</style><div class="css-8pjec1"></div></div></li></ul></nav><style data-emotion="css a8fx70">.css-a8fx70{max-width:100ch;margin:auto;padding-top:16px;}</style><div class="css-a8fx70"><style data-emotion="css 182iw6a">.css-182iw6a{padding:4px;}@media screen and (min-width: 40em){.css-182iw6a{padding:16px;}}</style><div class="css-182iw6a"><style data-emotion="css 15cp7lp">.css-15cp7lp{border-left:solid #c8c8ff 8px;padding-left:8px;padding-right:8px;}@media screen and (min-width: 40em){.css-15cp7lp{padding-left:32px;padding-right:32px;}}</style><div class="css-15cp7lp"><style data-emotion="css 1ycapm">.css-1ycapm{color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:24px;}</style><style data-emotion="css f9700n">.css-f9700n{color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:24px;color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:24px;}</style><h2 class="css-f9700n">A bit of a recap</h2>
<style data-emotion="css 1bgi9o3">.css-1bgi9o3{color:var(--theme-ui-colors-text);font-family:Lato;font-weight:400;line-height:1.625;}</style><style data-emotion="css 1ru80hs">.css-1ru80hs{color:var(--theme-ui-colors-text);font-family:Lato;font-weight:400;line-height:1.625;color:var(--theme-ui-colors-text);font-family:Lato;font-weight:400;line-height:1.625;}</style><p class="css-1ru80hs">As an intern at the <style data-emotion="css ttyvc7">.css-ttyvc7{color:var(--theme-ui-colors-primary);}</style><style data-emotion="css 1er51ag">.css-1er51ag{color:var(--theme-ui-colors-primary);color:var(--theme-ui-colors-primary);}</style><a href="https://ocamllabs.io/" class="css-1er51ag">OCamlLab</a>, my project is to port <a href="https://mirage.io/" class="css-1er51ag">MirageOS</a> on a <a href="https://www.espressif.com/en/products/hardware/esp32/overview" class="css-1er51ag">ESP32 boards</a>.</p>
<p class="css-1ru80hs">This will be done by two main projects:</p>
<ul class="css-zezy6m">
<li class="css-zezy6m">
<p class="css-1ru80hs">Set up a cross-compilation toolchain from Mirage libraries to ESP32 target. It will be mainly for bytecode generation along with C stubs built with the xtensa gcc toolchain.</p>
</li>
<li class="css-zezy6m">
<p class="css-1ru80hs">Add a new target to the OCaml compiler to have native code generation for xtensa processors.</p>
</li>
</ul>
<style data-emotion="css 3a6syt">.css-3a6syt{color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:20px;}</style><style data-emotion="css v7vzk8">.css-v7vzk8{color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:20px;color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:20px;}</style><h3 class="css-v7vzk8">What is ESP32</h3>
<p class="css-1ru80hs">ESP32 is a series of chip microcontrollers which embeds Wifi and Bluetooth controllers. It integrates the following hardware:</p>
<ul class="css-zezy6m">
<li class="css-zezy6m">Dual core Xtensa LX6 processors - 240Mhz</li>
<li class="css-zezy6m">Ultra-low power coprocessor</li>
<li class="css-zezy6m">520kb of RAM</li>
<li class="css-zezy6m">4Mb of read-only flash</li>
<li class="css-zezy6m">Wifi b/g/n transceiver</li>
<li class="css-zezy6m">Bluetooth 4.2 Low Energy</li>
<li class="css-zezy6m">Multiple peripheral interfaces</li>
<li class="css-zezy6m">5Î¼A deep-sleep current</li>
</ul>
<p class="css-1ru80hs">The base price of such a chip is $5, which makes it fairly cheap. Here are some derivations of the ESP32:</p>
<ul class="css-zezy6m">
<li class="css-zezy6m"><a href="https://wiki.wemos.cc/products:lolin32:lolin32_lite" class="css-1er51ag">Base chip + USB</a> ($5)</li>
<li class="css-zezy6m"><a href="https://www.sparkfun.com/products/13907" class="css-1er51ag">Base chip + USB + Battery powered</a> ($20)</li>
<li class="css-zezy6m"><a href="http://www.electrodragon.com/product/esp32-wrover-v4-module-based-esp32/" class="css-1er51ag">Base chip + 4Mb PSRAM</a> ($4.40)</li>
<li class="css-zezy6m"><a href="http://www.electrodragon.com/product/esp32-wrover-kit/" class="css-1er51ag">Base chip + USB  + 4Mb PSRAM + LCD screen + JTAG over USB + SD card support</a> ($37.10)</li>
</ul>
<p class="css-1ru80hs">Hence this chip is very interesting for IoT projects, as it is versatile, low-power, and connected.</p>
<style data-emotion="css 1rsbnr4">.css-1rsbnr4{color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:16px;}</style><style data-emotion="css cfitkr">.css-cfitkr{color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:16px;color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:16px;}</style><h4 class="css-cfitkr">Programming on ESP32</h4>
<p class="css-1ru80hs">Espressif published a development guide and toolchain for C programming. You can find it as the <a href="http://esp-idf.readthedocs.io/en/latest/" class="css-1er51ag">ESP-IDF</a> (IoT Development Framework) and there are all the resources needed to develop on this board. It contains a lot of documented libraries that help exploiting the features of ESP32 chips. It&#x27;s fairly easy to compile a simple program as the framework will automatically compile and link the code with ESP libraries and newlib, creating a flashable binary.</p>
<p class="css-1ru80hs">This chip can also programmed trough:</p>
<ul class="css-zezy6m">
<li class="css-zezy6m"><a href="http://micropython.org/download#esp32" class="css-1er51ag">MicroPython</a> (Python for microcontrollers) features a Python toplevel on serial over USB. MicroPython libraries includes for example an easy way to connect to a Wifi hotspot and communicate with the world.</li>
<li class="css-zezy6m"><a href="https://github.com/espressif/arduino-esp32" class="css-1er51ag">Arduino</a></li>
</ul>
<h3 class="css-v7vzk8">What is Mirage ?</h3>
<p class="css-1ru80hs">&quot;MirageOS is a library operating system that constructs unikernels for secure, high-performance network applications across a variety of cloud computing and mobile platforms&quot;. Written in OCaml, Mirage relies on opam package manager to download and build libraries.</p>
<ul class="css-zezy6m">
<li class="css-zezy6m">
<p class="css-1ru80hs">The <style data-emotion="css wdmob4">.css-wdmob4{font-family:Menlo,monospace;font-size:inherit;}</style><style data-emotion="css ciwx4y">.css-ciwx4y{font-family:Menlo,monospace;font-size:inherit;font-family:Menlo,monospace;font-size:inherit;}</style><code class="css-ciwx4y">mirage</code> package contains the OCaml tool which will build an unikernel from sources to a specific target. <code class="css-ciwx4y">mirage configure -t xen</code> would for example create the list of packages needed to compile an unikernel for a Xen hypervisor.</p>
</li>
<li class="css-zezy6m">
<p class="css-1ru80hs">The mirage library is composed of a lot of features libraries, sometimes target-specific, whose types implement one of the <code class="css-ciwx4y">mirage-types</code>. These types defines interfaces for:</p>
<ul class="css-zezy6m">
<li class="css-zezy6m">Block devices</li>
<li class="css-zezy6m">Channels</li>
<li class="css-zezy6m">Time</li>
<li class="css-zezy6m">Console</li>
<li class="css-zezy6m">Filesystem</li>
<li class="css-zezy6m">Network</li>
<li class="css-zezy6m">...</li>
</ul>
</li>
</ul>
<h3 class="css-v7vzk8">Why Mirage should be ported to the ESP32</h3>
<p class="css-1ru80hs">Mirage is a library that allows the user to build applications without relying on a particular operating system, compiling it with minimal amount of libraries needed to run the application on bare metal or on top of an hypervisor. Thus a MirageOS unikernel can rely on operating system features such as network or devices without shipping millions of useless lines of code a typical OS can have.</p>
<p class="css-1ru80hs">This improves security, performances and reduces the memory footprint of an application. That&#x27;s why having Mirage unikernels running on ESP32 boards is a great goal.</p>
<h2 class="css-f9700n">Where are we now ?</h2>
<p class="css-1ru80hs">We want to be able to ship OCaml code on ESP32 boards. However, Xtensa processors use a <a href="https://0x04.net/~mwk/doc/xtensa.pdf" class="css-1er51ag">specific</a> instruction set. This instruction set is currently not supported by the OCaml compiler, the only compiler toolchain building for ESP32 being the <a href="https://dl.espressif.com/dl/xtensa-esp32-elf-linux64-1.22.0-61-gab8375a-5.2.0.tar.gz" class="css-1er51ag">xtensa-esp32-elf</a> toolchain whose code hasn&#x27;t been distributed.</p>
<h3 class="css-v7vzk8">Bytecode execution on the ESP32</h3>
<p class="css-1ru80hs">Hopefully, OCaml runtimes are written in C and can be built with the cross toolchain. With some efforts tweaking constants and Newlib compilation settings, Sadiq successfully compiled an OCaml code into bytecode which could be executed on an ESP32 board: <a href="https://toao.com/blog/getting-ocaml-running-on-the-esp32" class="css-1er51ag">Getting OCaml running on the ESP32</a>. This is promising as it means we could build, link and run any OCaml library on an ESP32 target.</p>
<p class="css-1ru80hs">However two problems were encountered:</p>
<ul class="css-zezy6m">
<li class="css-zezy6m">
<p class="css-1ru80hs">OCaml&#x27;s <code class="css-ciwx4y">Printf.printf</code> doesn&#x27;t work out of the box. I figured out that ESP-IDF&#x27;s VFS is a bit broken and doesn&#x27;t correctly implement file descriptors behavior. I&#x27;ll write on article on that matter.</p>
</li>
<li class="css-zezy6m">
<p class="css-1ru80hs">Using several libraries such as <code class="css-ciwx4y">Map</code> and <code class="css-ciwx4y">Pervasives</code>, the size of the generated bytecode becomes too big for the 520kb RAM to hold. No problem! Let&#x27;s put it in flash, I just have to change a <code class="css-ciwx4y">static</code> to a <code class="css-ciwx4y">static const</code> in the C file containing the bytecode. Well it doesn&#x27;t work out of the box as the bytecode runtime actually perform an update pass over the bytecode to prepare it for threaded mode, therefore if the bytecode is set in flash memory it can&#x27;t be updated and an exception is raised. That pass had to be disabled in order to fix the issue. After that I could build more complex programs, generate their bytecode and run it on an ESP32 board.</p>
</li>
</ul>
<h3 class="css-v7vzk8">Cross-compilation of mirage libraries</h3>
<h4 class="css-cfitkr">Mirage ESP32 target</h4>
<p class="css-1ru80hs">The first step towards compiling an unikernel with Mirage is to add a new target on the mirage configuration tool. Adding an esp32 target allows <code class="css-ciwx4y">mirage configure -t esp32</code> to generate an unikernel package which will depend on ESP32 libraries implementations.</p>
<h4 class="css-cfitkr">opam-cross-esp32 libraries</h4>
<p class="css-1ru80hs">Mirage libraries required to build an unikernel come in a great number. Opam handles everything in case of host compilation, but there isn&#x27;t yet any way to cross-compile a package with its dependencies out of the box.</p>
<p class="css-1ru80hs">As I looked online I figured out the best way to cross-compile stuff on OCaml is to do as <code class="css-ciwx4y">whitequark</code> did with <code class="css-ciwx4y">opam-cross-android</code>. The idea is to create for every package <code class="css-ciwx4y">&lt;*name*&gt;</code>, a clone package <code class="css-ciwx4y">&lt;*name-esp32*&gt;</code> which is cross-compiled with an <code class="css-ciwx4y">ocaml-esp32</code> cross-toolchain and installed within a specific prefix.</p>
<p class="css-1ru80hs">This is tedious work, and it can hardly be automated as there are a lot of patterns and use of different build systems. Generation of bytecode libraries along with C libraries is not such a problem, but it&#x27;s a bit ugly as some of these libraries rely on preprocessing libraries and tools that need to be built with a host toolchain.
For example a build that rely on an ocamlbuild plugin need to have the plugin built with the host toolchain, before switching to the target toolchain in order to build the library.</p>
<p class="css-1ru80hs">Right now every dependency of the noop mirage sample has its <code class="css-ciwx4y">-esp32</code> version in <a href="https://www.github.com/TheLortex/opam-cross-esp32" class="css-1er51ag">opam-cross-esp32</a>. However it has been done in a funky/hacky way and it doesn&#x27;t build out of the box.</p>
<h3 class="css-v7vzk8">Native xtensa backend for the OCaml compiler</h3>
<p class="css-1ru80hs">To reduce memory footprint and speed up execution, the end goal is to have a native backend of the OCaml compiler for ESP32 targets. This implies digging in the compiler source code as the documentation is fairly.. <a href="https://github.com/ocamllabs/ocaml-internals/wiki" class="css-1er51ag">empty</a>. The work consists in writing the last layer of compilation which generates assembly code from the last intermediary language of OCaml compilation. It&#x27;s not that hard as I can read the source of several other backends for common architectures (ARM, i386, ..) and translate from there using the Xtensa Instruction Set Architecture.</p></div></div></div></main></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/articles/mirage-and-esp32/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-d97c469be019da6163ec.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-9e510c30c2aa75038774.js\"],\"component---src-pages-articles-tsx\":[\"/component---src-pages-articles-tsx-6d4938919c2b02a7b00b.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-cb18ecbee42e63fddf96.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-20-mirage-and-esp-32-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-20-mirage-and-esp-32-mdx-f96a9f65ac3afff855e9.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-27-last-week-tonight-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-27-last-week-tonight-mdx-4b72104b59cd3cd1d77b.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-28-the-xtensa-architecture-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-28-the-xtensa-architecture-mdx-50c7099b5a632f80e284.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-04-27-compiling-and-linking-for-esp-32-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-04-27-compiling-and-linking-for-esp-32-mdx-9f8a2218cba45eb7ca26.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-05-04-success-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-05-04-success-mdx-9cd038eddb542756d381.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-06-22-build-your-own-mirage-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-06-22-build-your-own-mirage-mdx-36034129f1a2178839c4.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-10-02-status-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-10-02-status-mdx-ca1c87152c2fa8ad3fc8.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-10-02-what-now-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-10-02-what-now-mdx-226617db739a95684729.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2023-05-05-value-speculation-ocaml-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2023-05-05-value-speculation-ocaml-mdx-66d1373c6378d366bfa0.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-amogu-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-amogu-mdx-9da4e8693fb5acee9020.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-esp-32-index-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-esp-32-index-mdx-f06cb0b4fc79c9902197.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-mean-field-index-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-mean-field-index-mdx-5b565943f81866559851.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-mirage-4-index-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-mirage-4-index-mdx-756cc66b5dc37f1053b4.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-theoremkb-index-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-theoremkb-index-mdx-631d8fdc7fe15d577636.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-windos-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-windos-mdx-63c59bdd19103f135243.js\"],\"component---src-pages-photography-tsx\":[\"/component---src-pages-photography-tsx-a03fa3f857230a2d0611.js\"],\"component---src-pages-projects-tsx\":[]}";
          </script>
        <script>window.___webpackCompilationHash="e6f3751ce20f6530e40c";</script><script src="/webpack-runtime-4556567c4495c7c2cbad.js" async></script><script src="/framework-32465eaa607188618171.js" async></script><script src="/app-d97c469be019da6163ec.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>