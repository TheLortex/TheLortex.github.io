<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.9.0"/><style data-href="/styles.2fc987ab99476a778f24.css" data-identity="gatsby-global-css">@font-face{font-named-instance:"Light";font-display:swap;font-family:Lato;font-style:normal;font-weight:300;src:url(/fonts/Lato-Light.ttf) format("truetype")}@font-face{font-named-instance:"Regular";font-display:swap;font-family:Lato;font-style:normal;font-weight:400;src:url(/fonts/Lato-Regular.ttf) format("truetype")}@font-face{font-named-instance:"Bold";font-display:swap;font-family:Lato;font-style:normal;font-weight:700;src:url(/fonts/Lato-Bold.ttf) format("truetype")}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=53aa06cf17e4239d0dba6ffd09854e02" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><style data-emotion="css-global 109rmrq" data-gatsby-head="true">html{--theme-ui-colors-text:#333;--theme-ui-colors-background:#f8f8ff;--theme-ui-colors-primary:#ff9f29;--theme-ui-colors-secondary:#51697B;--theme-ui-colors-muted:#f6f6f6;color:var(--theme-ui-colors-text);background-color:var(--theme-ui-colors-background);}</style><style data-emotion="css-global dleq8w" data-gatsby-head="true">*{box-sizing:border-box;}html{font-family:Lato;line-height:1.625;font-weight:400;}body{margin:0;}</style><title data-gatsby-head="true">Projects</title></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.documentElement.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion="css-global 109rmrq">html{--theme-ui-colors-text:#333;--theme-ui-colors-background:#f8f8ff;--theme-ui-colors-primary:#ff9f29;--theme-ui-colors-secondary:#51697B;--theme-ui-colors-muted:#f6f6f6;color:var(--theme-ui-colors-text);background-color:var(--theme-ui-colors-background);}</style><style data-emotion="css-global dleq8w">*{box-sizing:border-box;}html{font-family:Lato;line-height:1.625;font-weight:400;}body{margin:0;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion="css mhypsu">.css-mhypsu{padding-left:16px;padding-right:16px;padding-top:8px;padding-bottom:32px;}@media screen and (min-width: 40em){.css-mhypsu{padding-left:32px;padding-right:32px;}}.css-mhypsu a{color:var(--theme-ui-colors-secondary);}</style><main class="css-mhypsu"><style data-emotion="css nqlwoc">.css-nqlwoc{max-width:80ch;margin:auto;}</style><nav class="css-nqlwoc"><style data-emotion="css 1u5jjkp">.css-1u5jjkp{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding:0;}</style><ul class="css-1u5jjkp"><style data-emotion="css x4n4mc">.css-x4n4mc{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}</style><li class="css-x4n4mc"><style data-emotion="css ijnf57">.css-ijnf57{padding-top:64px;}</style><div class="css-ijnf57"><style data-emotion="css 1b6s52i">.css-1b6s52i{-webkit-transform:rotate(-30deg);-moz-transform:rotate(-30deg);-ms-transform:rotate(-30deg);transform:rotate(-30deg);width:50px;transform-origin:top left;padding:4px;font-size:24px;}@media screen and (min-width: 40em){.css-1b6s52i{width:100px;}}</style><div class="css-1b6s52i"><style data-emotion="css 1hpv60u">.css-1hpv60u{-webkit-text-decoration:none;text-decoration:none;color:var(--theme-ui-colors-secondary);}.css-1hpv60u:hover{-webkit-text-decoration:underline;text-decoration:underline;}.css-1hpv60u::after{display:block;content:attr(title);font-weight:700;height:0px;overflow:hidden;visibility:hidden;}</style><a title="home" class="css-1hpv60u" href="/">home</a></div></div><style data-emotion="css 1d8reql">.css-1d8reql{-webkit-align-self:stretch;-ms-flex-item-align:stretch;align-self:stretch;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;}</style><div class="css-1d8reql"><style data-emotion="css 1391gw0">.css-1391gw0{background-color:var(--theme-ui-colors-primary);border-radius:100%;width:24px;height:24px;position:absolute;top:-6px;left:-6px;}</style><div class="css-1391gw0"></div><style data-emotion="css 1ohyuec">.css-1ohyuec{background-color:var(--theme-ui-colors-primary);-webkit-flex:1;-ms-flex:1;flex:1;height:12px;}</style><div class="css-1ohyuec"></div></div></li><li class="css-x4n4mc"><div class="css-ijnf57"><div class="css-1b6s52i"><a title="projects" class="css-1hpv60u" href="/projects/">projects</a></div></div><div class="css-1d8reql"><div class="css-1391gw0"></div><div class="css-1ohyuec"></div></div></li><li class="css-x4n4mc"><div class="css-ijnf57"><div class="css-1b6s52i"><a title="articles" class="css-1hpv60u" href="/articles/">articles</a></div></div><div class="css-1d8reql"><style data-emotion="css wxtter">.css-wxtter{background-color:white;border:4px black solid;border-radius:100%;width:24px;height:24px;position:absolute;z-index:1000;top:-6px;left:-6px;}</style><div class="css-wxtter"></div><div class="css-1ohyuec"></div></div><style data-emotion="css wvopc1">.css-wvopc1{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;}</style><div class="css-wvopc1"><style data-emotion="css 113tkru">.css-113tkru{background-color:#FC4F00;margin-left:4px;margin-top:-4px;height:40px;width:40px;-webkit-clip-path:polygon(0% 0%, 8px 0%, 100% 32px, 100% 100%, 32px 100%, 0% 8px);clip-path:polygon(0% 0%, 8px 0%, 100% 32px, 100% 100%, 32px 100%, 0% 8px);}</style><div class="css-113tkru"></div><style data-emotion="css l5xv05">.css-l5xv05{position:relative;}</style><div class="css-l5xv05"><style data-emotion="css sba7cb">.css-sba7cb{position:absolute;width:1000px;bottom:6px;left:-4px;}</style><div class="css-sba7cb"><style data-emotion="css vcqf7v">.css-vcqf7v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;gap:16px;height:0;}</style><div class="css-vcqf7v"><style data-emotion="css rcsbs7">.css-rcsbs7{width:40px;border-bottom:solid 12px #FC4F00;box-sizing:border-box;border-bottom-right-radius:100px;border-top-right-radius:100px;position:relative;}</style><div class="css-rcsbs7"><style data-emotion="css 1hgbd7r">.css-1hgbd7r{background-color:#FC4F00;border-radius:100%;width:24px;height:24px;position:absolute;top:-6px;right:-6px;}</style><div class="css-1hgbd7r"></div></div><style data-emotion="css jkw5sz">.css-jkw5sz{margin:0;-webkit-text-decoration:underline;text-decoration:underline;color:var(--theme-ui-colors-secondary);}</style><h2 class="css-jkw5sz">Compiling and linking for ESP32</h2></div></div></div></div></li><li class="css-x4n4mc"><div class="css-ijnf57"><div class="css-1b6s52i"><a title="photography" class="css-1hpv60u" href="/photography/">photography</a></div></div><div class="css-1d8reql"><div class="css-1391gw0"></div><style data-emotion="css 8pjec1">.css-8pjec1{-webkit-flex:1;-ms-flex:1;flex:1;height:12px;}</style><div class="css-8pjec1"></div></div></li></ul></nav><style data-emotion="css a8fx70">.css-a8fx70{max-width:100ch;margin:auto;padding-top:16px;}</style><div class="css-a8fx70"><style data-emotion="css 182iw6a">.css-182iw6a{padding:4px;}@media screen and (min-width: 40em){.css-182iw6a{padding:16px;}}</style><div class="css-182iw6a"><style data-emotion="css 15cp7lp">.css-15cp7lp{border-left:solid #c8c8ff 8px;padding-left:8px;padding-right:8px;}@media screen and (min-width: 40em){.css-15cp7lp{padding-left:32px;padding-right:32px;}}</style><div class="css-15cp7lp"><style data-emotion="css 1bgi9o3">.css-1bgi9o3{color:var(--theme-ui-colors-text);font-family:Lato;font-weight:400;line-height:1.625;}</style><style data-emotion="css 1ru80hs">.css-1ru80hs{color:var(--theme-ui-colors-text);font-family:Lato;font-weight:400;line-height:1.625;color:var(--theme-ui-colors-text);font-family:Lato;font-weight:400;line-height:1.625;}</style><p class="css-1ru80hs">I&#x27;ve got native OCaml code running! It seems to pass all the runtime tests, and as I fixed some GC segfaults I&#x27;m now pretty confident in the backend code.
It&#x27;s not optimized at all, but you can now experiment with OCaml on ESP32 MCUs.</p>
<style data-emotion="css 1ycapm">.css-1ycapm{color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:24px;}</style><style data-emotion="css f9700n">.css-f9700n{color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:24px;color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:24px;}</style><h2 class="css-f9700n">OCaml cross-compiler installation</h2>
<p class="css-1ru80hs">Switch opam to OCaml version 4.06 or a 4.07 as only these two versions are supported, using the <style data-emotion="css wdmob4">.css-wdmob4{font-family:Menlo,monospace;font-size:inherit;}</style><style data-emotion="css ciwx4y">.css-ciwx4y{font-family:Menlo,monospace;font-size:inherit;font-family:Menlo,monospace;font-size:inherit;}</style><code class="css-ciwx4y">opam switch</code> command.</p>
<p class="css-1ru80hs">Add my cross-compilation repository in opam, with:</p>
<style data-emotion="css 1mlz4oi">.css-1mlz4oi{font-family:Menlo,monospace;overflow-x:auto;}.css-1mlz4oi code{color:inherit;}</style><style data-emotion="css 1mjvwaj">.css-1mjvwaj{font-family:Menlo,monospace;overflow-x:auto;font-family:Menlo,monospace;overflow-x:auto;}.css-1mjvwaj code{color:inherit;}.css-1mjvwaj code{color:inherit;}</style><pre class="css-1mjvwaj"><code class="css-ciwx4y">opam repo add cross-esp32 https://github.com/TheLortex/opam-cross-esp32.git
</code></pre>
<p class="css-1ru80hs">After that, you&#x27;ll be able to install the cross-compiler, with:</p>
<pre class="css-1mjvwaj"><code class="css-ciwx4y">opam install ocaml-esp32
</code></pre>
<p class="css-1ru80hs">You now have an OCaml cross-compiler for esp32 installed in <code class="css-ciwx4y">~/.opam/&lt;switch&gt;/esp32-sysroot/</code>.</p>
<h2 class="css-f9700n">Cross-compiling OCaml libraries</h2>
<p class="css-1ru80hs">Your favorite build system can already cross-compile code. You can either use</p>
<ul class="css-zezy6m">
<li class="css-zezy6m"><code class="css-ciwx4y">jbuilder build -x esp32 ...</code></li>
<li class="css-zezy6m"><code class="css-ciwx4y">ocamlfind -toolchain esp32 ...</code></li>
<li class="css-zezy6m"><code class="css-ciwx4y">env OCAMLFIND_TOOLCHAIN=esp32 ocamlbuild ...</code>
to build libraries.</li>
</ul>
<p class="css-1ru80hs">The libraries used by these build systems are located in <code class="css-ciwx4y">~/.opam/&lt;switch&gt;/esp32-sysroot/lib/</code>. A good thing to know is that jbuilder automatically makes the difference between host code and target code, hence enabling the use of ppx tools.</p>
<h2 class="css-f9700n">Building an ESP32 application</h2>
<p class="css-1ru80hs">To build an esp32 application, you&#x27;ll need to link native code with the ESP-Iot Development Framework which contains libraries, bootloader code and linker scripts.</p>
<p class="css-1ru80hs"><style data-emotion="css ttyvc7">.css-ttyvc7{color:var(--theme-ui-colors-primary);}</style><style data-emotion="css 1er51ag">.css-1er51ag{color:var(--theme-ui-colors-primary);color:var(--theme-ui-colors-primary);}</style><a href="https://github.com/TheLortex/hello_caml" class="css-1er51ag">Hello caml</a> is an example of project structure using jbuilder that builds a flashable binary for esp32.</p>
<p class="css-1ru80hs">Basically, it&#x27;s not complicated:</p>
<ul class="css-zezy6m">
<li class="css-zezy6m">Build and ship OCaml code into a single object:<!-- -->
<ul class="css-zezy6m">
<li class="css-zezy6m">using the <code class="css-ciwx4y">-output-complete-obj</code> option on the native compiler <code class="css-ciwx4y">ocamlopt</code>.</li>
<li class="css-zezy6m">using <code class="css-ciwx4y">jbuilder build -x esp32 _build/default.esp32/main.exe.o</code> that will automatically use the option.</li>
</ul>
</li>
<li class="css-zezy6m">This object file&#x27;s entry point is <code class="css-ciwx4y">caml_main</code>. So the next thing to do is create a <code class="css-ciwx4y">startup-c.c</code> file that defines a function <code class="css-ciwx4y">app_main</code> which calls <code class="css-ciwx4y">caml_main</code>.</li>
<li class="css-zezy6m">Then everything needs to be linked together, and the ESP32 framework takes the lead to create the final binary.</li>
</ul></div></div></div></main></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/articles/compiling-and-linking-for-esp32/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-93ac6565766651f2888c.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-9e510c30c2aa75038774.js\"],\"component---src-pages-articles-tsx\":[\"/component---src-pages-articles-tsx-5fa3ddaedbfbc6821500.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-d71f797570aac80d0fa0.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-20-mirage-and-esp-32-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-20-mirage-and-esp-32-mdx-5d572da490dda791ec03.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-27-last-week-tonight-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-27-last-week-tonight-mdx-d1ce4d6d8b64af753cfb.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-28-the-xtensa-architecture-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-28-the-xtensa-architecture-mdx-9f2041da62e44edcd3d2.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-04-27-compiling-and-linking-for-esp-32-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-04-27-compiling-and-linking-for-esp-32-mdx-e71c41c3090a0ff226cb.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-05-04-success-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-05-04-success-mdx-ab5096ce3a39d7ed39a0.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-06-22-build-your-own-mirage-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-06-22-build-your-own-mirage-mdx-c30d9895c241b9e9732d.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-10-02-status-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-10-02-status-mdx-ce642848e4335515870c.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-10-02-what-now-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-10-02-what-now-mdx-5751f200cdeb17e20a99.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-amogu-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-amogu-mdx-9120e7912bf997bcf58a.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-esp-32-index-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-esp-32-index-mdx-014cfcc050db48732dcd.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-mean-field-index-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-mean-field-index-mdx-9ac2511379a8729c4db2.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-mirage-4-index-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-mirage-4-index-mdx-a4e43b66ba6f81512466.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-theoremkb-index-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-theoremkb-index-mdx-7ef3319c8c2e62abcc3b.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-windos-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-windos-mdx-b42973fc87ee9d5ec54d.js\"],\"component---src-pages-photography-tsx\":[\"/component---src-pages-photography-tsx-ec67f9b17aafd3f9b7fc.js\"],\"component---src-pages-projects-tsx\":[]}";
          </script>
        <script>window.___webpackCompilationHash="644908c9f482ff337d6b";</script><script src="/webpack-runtime-91cca74102ac166b89c8.js" async></script><script src="/framework-32465eaa607188618171.js" async></script><script src="/app-93ac6565766651f2888c.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>