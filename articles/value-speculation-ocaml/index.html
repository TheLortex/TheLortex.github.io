<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.9.0"/><meta charSet="utf-8" data-gatsby-head="true"/><meta name="viewport" content="width=device-width, initial-scale=1" data-gatsby-head="true"/><meta name="author" content="Lucas Pluvinage" data-gatsby-head="true"/><meta name="description" content="Lucas Pluvinage&#x27;s website" data-gatsby-head="true"/><meta name="keywords" content="" data-gatsby-head="true"/><style data-href="/styles.2fc987ab99476a778f24.css" data-identity="gatsby-global-css">@font-face{font-named-instance:"Light";font-display:swap;font-family:Lato;font-style:normal;font-weight:300;src:url(/fonts/Lato-Light.ttf) format("truetype")}@font-face{font-named-instance:"Regular";font-display:swap;font-family:Lato;font-style:normal;font-weight:400;src:url(/fonts/Lato-Regular.ttf) format("truetype")}@font-face{font-named-instance:"Bold";font-display:swap;font-family:Lato;font-style:normal;font-weight:700;src:url(/fonts/Lato-Bold.ttf) format("truetype")}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=53aa06cf17e4239d0dba6ffd09854e02" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=53aa06cf17e4239d0dba6ffd09854e02"/><style data-emotion="css-global 109rmrq" data-gatsby-head="true">html{--theme-ui-colors-text:#333;--theme-ui-colors-background:#f8f8ff;--theme-ui-colors-primary:#ff9f29;--theme-ui-colors-secondary:#51697B;--theme-ui-colors-muted:#f6f6f6;color:var(--theme-ui-colors-text);background-color:var(--theme-ui-colors-background);}</style><style data-emotion="css-global dleq8w" data-gatsby-head="true">*{box-sizing:border-box;}html{font-family:Lato;line-height:1.625;font-weight:400;}body{margin:0;}</style><title data-gatsby-head="true">Lucas Pluvinage - Implementing value speculation in OCaml</title><link rel="icon" href="/static/favicon-ba1419b983b3bccb202cb22b00fe921f.ico" data-gatsby-head="true"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.documentElement.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion="css-global 109rmrq">html{--theme-ui-colors-text:#333;--theme-ui-colors-background:#f8f8ff;--theme-ui-colors-primary:#ff9f29;--theme-ui-colors-secondary:#51697B;--theme-ui-colors-muted:#f6f6f6;color:var(--theme-ui-colors-text);background-color:var(--theme-ui-colors-background);}</style><style data-emotion="css-global dleq8w">*{box-sizing:border-box;}html{font-family:Lato;line-height:1.625;font-weight:400;}body{margin:0;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion="css mhypsu">.css-mhypsu{padding-left:16px;padding-right:16px;padding-top:8px;padding-bottom:32px;}@media screen and (min-width: 40em){.css-mhypsu{padding-left:32px;padding-right:32px;}}.css-mhypsu a{color:var(--theme-ui-colors-secondary);}</style><main class="css-mhypsu"><style data-emotion="css nqlwoc">.css-nqlwoc{max-width:80ch;margin:auto;}</style><nav class="css-nqlwoc"><style data-emotion="css 1u5jjkp">.css-1u5jjkp{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding:0;}</style><ul class="css-1u5jjkp"><style data-emotion="css x4n4mc">.css-x4n4mc{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}</style><li class="css-x4n4mc"><style data-emotion="css ijnf57">.css-ijnf57{padding-top:64px;}</style><div class="css-ijnf57"><style data-emotion="css 1b6s52i">.css-1b6s52i{-webkit-transform:rotate(-30deg);-moz-transform:rotate(-30deg);-ms-transform:rotate(-30deg);transform:rotate(-30deg);width:50px;transform-origin:top left;padding:4px;font-size:24px;}@media screen and (min-width: 40em){.css-1b6s52i{width:100px;}}</style><div class="css-1b6s52i"><style data-emotion="css 1hpv60u">.css-1hpv60u{-webkit-text-decoration:none;text-decoration:none;color:var(--theme-ui-colors-secondary);}.css-1hpv60u:hover{-webkit-text-decoration:underline;text-decoration:underline;}.css-1hpv60u::after{display:block;content:attr(title);font-weight:700;height:0px;overflow:hidden;visibility:hidden;}</style><a title="home" class="css-1hpv60u" href="/">home</a></div></div><style data-emotion="css 1d8reql">.css-1d8reql{-webkit-align-self:stretch;-ms-flex-item-align:stretch;align-self:stretch;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;}</style><div class="css-1d8reql"><style data-emotion="css 1391gw0">.css-1391gw0{background-color:var(--theme-ui-colors-primary);border-radius:100%;width:24px;height:24px;position:absolute;top:-6px;left:-6px;}</style><div class="css-1391gw0"></div><style data-emotion="css 1ohyuec">.css-1ohyuec{background-color:var(--theme-ui-colors-primary);-webkit-flex:1;-ms-flex:1;flex:1;height:12px;}</style><div class="css-1ohyuec"></div></div></li><li class="css-x4n4mc"><div class="css-ijnf57"><div class="css-1b6s52i"><a title="projects" class="css-1hpv60u" href="/projects/">projects</a></div></div><div class="css-1d8reql"><div class="css-1391gw0"></div><div class="css-1ohyuec"></div></div></li><li class="css-x4n4mc"><div class="css-ijnf57"><div class="css-1b6s52i"><a title="articles" class="css-1hpv60u" href="/articles/">articles</a></div></div><div class="css-1d8reql"><style data-emotion="css wxtter">.css-wxtter{background-color:white;border:4px black solid;border-radius:100%;width:24px;height:24px;position:absolute;z-index:1000;top:-6px;left:-6px;}</style><div class="css-wxtter"></div><div class="css-1ohyuec"></div></div><style data-emotion="css wvopc1">.css-wvopc1{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;}</style><div class="css-wvopc1"><style data-emotion="css 113tkru">.css-113tkru{background-color:#FC4F00;margin-left:4px;margin-top:-4px;height:40px;width:40px;-webkit-clip-path:polygon(0% 0%, 8px 0%, 100% 32px, 100% 100%, 32px 100%, 0% 8px);clip-path:polygon(0% 0%, 8px 0%, 100% 32px, 100% 100%, 32px 100%, 0% 8px);}</style><div class="css-113tkru"></div><style data-emotion="css l5xv05">.css-l5xv05{position:relative;}</style><div class="css-l5xv05"><style data-emotion="css sba7cb">.css-sba7cb{position:absolute;width:1000px;bottom:6px;left:-4px;}</style><div class="css-sba7cb"><style data-emotion="css vcqf7v">.css-vcqf7v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;gap:16px;height:0;}</style><div class="css-vcqf7v"><style data-emotion="css rcsbs7">.css-rcsbs7{width:40px;border-bottom:solid 12px #FC4F00;box-sizing:border-box;border-bottom-right-radius:100px;border-top-right-radius:100px;position:relative;}</style><div class="css-rcsbs7"><style data-emotion="css 1hgbd7r">.css-1hgbd7r{background-color:#FC4F00;border-radius:100%;width:24px;height:24px;position:absolute;top:-6px;right:-6px;}</style><div class="css-1hgbd7r"></div></div><style data-emotion="css jkw5sz">.css-jkw5sz{margin:0;-webkit-text-decoration:underline;text-decoration:underline;color:var(--theme-ui-colors-secondary);}</style><h2 class="css-jkw5sz">Implementing value speculation in OCaml</h2></div></div></div></div></li><li class="css-x4n4mc"><div class="css-ijnf57"><div class="css-1b6s52i"><a title="photography" class="css-1hpv60u" href="/photography/">photography</a></div></div><div class="css-1d8reql"><div class="css-1391gw0"></div><style data-emotion="css 8pjec1">.css-8pjec1{-webkit-flex:1;-ms-flex:1;flex:1;height:12px;}</style><div class="css-8pjec1"></div></div></li></ul></nav><style data-emotion="css a8fx70">.css-a8fx70{max-width:100ch;margin:auto;padding-top:16px;}</style><div class="css-a8fx70"><style data-emotion="css 182iw6a">.css-182iw6a{padding:4px;}@media screen and (min-width: 40em){.css-182iw6a{padding:16px;}}</style><div class="css-182iw6a"><style data-emotion="css 15cp7lp">.css-15cp7lp{border-left:solid #c8c8ff 8px;padding-left:8px;padding-right:8px;}@media screen and (min-width: 40em){.css-15cp7lp{padding-left:32px;padding-right:32px;}}</style><div class="css-15cp7lp"><style data-emotion="css 1bgi9o3">.css-1bgi9o3{color:var(--theme-ui-colors-text);font-family:Lato;font-weight:400;line-height:1.625;}</style><style data-emotion="css 1ru80hs">.css-1ru80hs{color:var(--theme-ui-colors-text);font-family:Lato;font-weight:400;line-height:1.625;color:var(--theme-ui-colors-text);font-family:Lato;font-weight:400;line-height:1.625;}</style><p class="css-1ru80hs">CPUs are very good at doing things in parallel, even in a single core context.
Indeed, speculative execution of code and instruction reordering helps the CPU
ensure that the pipeline is always full. However, data dependencies in the
sequence of instructions might cause the CPU to have to wait for data, be it
from the L1 cache or the much slower RAM storage. Francesco Mazzoli shows in their blog post, <style data-emotion="css ttyvc7">.css-ttyvc7{color:var(--theme-ui-colors-primary);}</style><style data-emotion="css 1er51ag">.css-1er51ag{color:var(--theme-ui-colors-primary);color:var(--theme-ui-colors-primary);}</style><a href="https://mazzo.li/posts/value-speculation.html" class="css-1er51ag">Beating the L1 cache with value speculation</a> ,
that optimizing the critical path will in some conditions yield huge performance
improvements.</p>
<p class="css-1ru80hs">This article demonstrates that this optimisation can be implemented in the
OCaml programming language. Knowing how OCaml values are represented in memory is useful, here is a chapter of Real World OCaml on that matter: <a href="https://dev.realworldocaml.org/runtime-memory-layout.html" class="css-1er51ag">Memory Representation of Values</a>.</p>
<style data-emotion="css 1ycapm">.css-1ycapm{color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:24px;}</style><style data-emotion="css f9700n">.css-f9700n{color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:24px;color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:24px;}</style><h2 class="css-f9700n">Fast list iterations using one simple trick™</h2>
<p class="css-1ru80hs">Let&#x27;s start by instantiating a linked list of 10000 random numbers.</p>
<style data-emotion="css 1sg9vzq">.css-1sg9vzq{padding:8px;}</style><pre class="prism-code language-ocaml css-1sg9vzq" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">let</span><span class="token plain"> l </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> List</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">init </span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">_</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">-&gt;</span><span class="token plain"> Random</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">int </span><span class="token number" style="color:rgb(247, 140, 108)">1024</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div></pre>
<p class="css-1ru80hs">Now, let&#x27;s sum the numbers 100k times and see how long that takes. To obtain these statistics, <style data-emotion="css wdmob4">.css-wdmob4{font-family:Menlo,monospace;font-size:inherit;}</style><style data-emotion="css ciwx4y">.css-ciwx4y{font-family:Menlo,monospace;font-size:inherit;font-family:Menlo,monospace;font-size:inherit;}</style><code class="css-ciwx4y">perf stat</code> was used with the default settings on programs compiled with OCaml 5.0.</p>
<pre class="prism-code language-ocaml css-1sg9vzq" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">let</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">rec</span><span class="token plain"> sum </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">accumulator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cell</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> int list</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">match</span><span class="token plain"> cell </span><span class="token keyword" style="color:rgb(127, 219, 202)">with</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token operator" style="color:rgb(127, 219, 202)">|</span><span class="token plain"> head</span><span class="token punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">tail </span><span class="token operator" style="color:rgb(127, 219, 202)">-&gt;</span><span class="token plain"> sum </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">accumulator </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> head</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> tail</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token operator" style="color:rgb(127, 219, 202)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">-&gt;</span><span class="token plain"> accumulator</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">_</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">to</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100000</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">do</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  ignore </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sum </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> l</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">done</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div></pre>
<pre class="prism-code language-python css-1sg9vzq" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain"> Performance counter stats for &#x27;./a.out sum&#x27;:</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">          1 368,91 msec task-clock:u                     #    0,999 CPUs utilized</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">     4 835 597 233      cycles:u                         #    3,532 GHz</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">     9 005 641 989      instructions:u                   #    1,86  insn per cycle</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">     3 001 229 709      branches:u                       #    2,192 G/sec</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">           195 819      branch-misses:u                  #    0,01% of all branches</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div></pre>
<p class="css-1ru80hs">Conveniently, we&#x27;re doing one billion additions (10000 list items, repeated 100k times). So each iteration is taking:</p>
<ul class="css-zezy6m">
<li class="css-zezy6m">1.36 nanoseconds</li>
<li class="css-zezy6m">4.8 cycles</li>
<li class="css-zezy6m">9 instructions</li>
<li class="css-zezy6m">3 branches</li>
</ul>
<p class="css-1ru80hs">We can already see that the CPU is cramming multiple instructions per cycle.
Using the <a href="https://godbolt.org/" class="css-1er51ag">compiler explorer</a>, the following assembly is obtained:</p>
<pre class="prism-code language-nasm css-1sg9vzq" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token label function" style="color:rgb(130, 170, 255)">camlExample__sum_268:</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        subq    </span><span class="token number" style="color:rgb(247, 140, 108)">$8</span><span class="token plain">, </span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">rsp</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token label function" style="color:rgb(130, 170, 255)">.L101:</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        cmpq    (</span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">r14</span><span class="token plain">), </span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">r15</span><span class="token plain">         # check if GC is waiting for us</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        jbe     .L102                # branch #</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token label function" style="color:rgb(130, 170, 255)">.L103:</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        testb   </span><span class="token number" style="color:rgb(247, 140, 108)">$1</span><span class="token plain">, </span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">bl</span><span class="token plain">              # check if at end of list</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        je      .L100                # branch #</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        addq    </span><span class="token number" style="color:rgb(247, 140, 108)">$8</span><span class="token plain">, </span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">rsp</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        ret</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token label function" style="color:rgb(130, 170, 255)">.L100:</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        movq    </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">(</span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">rbx</span><span class="token plain">), </span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">rdi</span><span class="token plain">        # load tail element of list</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        movq    (</span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">rbx</span><span class="token plain">), </span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">rbx</span><span class="token plain">         # load head element of list</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        leaq    </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">(</span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">rbx</span><span class="token plain">,</span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">rax</span><span class="token plain">), </span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">rax</span><span class="token plain">  # add it to accumulator</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        movq    </span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">rdi</span><span class="token plain">, </span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token register variable" style="color:rgb(214, 222, 235)">rbx</span><span class="token plain">           # move tail element for next iteration</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        jmp     .L101</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token label function" style="color:rgb(130, 170, 255)">.L102:</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        call    caml_call_gc@PLT</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token label function" style="color:rgb(130, 170, 255)">.L104:</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        jmp     .L103</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div></pre>
<p class="css-1ru80hs">I&#x27;ve tried to think like a CPU in order to explain the numbers according to the perf results, but as so many pieces are involved I assumed it would be hard for everything to be correct. Instead, we&#x27;ll try to get a good <em class="css-zezy6m">intuition</em> by thinking in terms of <em class="css-zezy6m">data dependency</em>. Basically, the assumption is that things that do not depend on each other can be ran in parallel. The second assumption is that thanks to the <em class="css-zezy6m">branch predictor</em>, branch instructions are supposed to have zero cost and they don&#x27;t introduce data dependencies. Instead, the CPU predicts whether the program will go through the branch and continue execution. In case of misprediction, the CPU will roll back computations for us.</p>
<p class="css-1ru80hs">So here is the data dependency chart for this program, showing how two iterations are expected to be ran, with the critical path in red:</p>
<span><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/0ee27ac4c33fd4dc2224c18363d91a17/d07ca/sum_chart.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 22.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAABQElEQVQY0xWQ20oCURSG9wP0Er1MF11EWhB1W+8SGV0UjDHdCqJiUXlKi6CcLDyk4OSMlofUOc+4Z/boaAOy2l6txcf/869/Ic00ARMydWZeUjHNmOk4cXexiLrzeVrB+BDEFvJVBQ0l6VS3LDAwfletSWSsaYkJITGLkIRh25E7MltzuFeEZL4JCt9Upo8PeyST2rYz90H9Jhmwbq8Di6fCzrLEHXXOQuvtN+5EF1pgVcrny1x6wy3kdnWqIdlUwMtng37xZd/L5w6Q2xZh3u+BQ+dvpQzDagV0GoJFAUhHBJPuo4/S8Ygrhv56XZh9d8ARvkCuVUH6rMHKv2KYhqmUIQPbYVoxTM9mxqrGyLrO0LqM5/uMbBgXdZ6PPhe5zWqjsUXfE5M17bI7GLA//T4rKSpLGUs9bFMQrsr1BvsP2f8CVHGId2YAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="data chart"
        title=""
        src="/static/0ee27ac4c33fd4dc2224c18363d91a17/c1b63/sum_chart.png"
        srcset="/static/0ee27ac4c33fd4dc2224c18363d91a17/5a46d/sum_chart.png 300w,
/static/0ee27ac4c33fd4dc2224c18363d91a17/0a47e/sum_chart.png 600w,
/static/0ee27ac4c33fd4dc2224c18363d91a17/c1b63/sum_chart.png 1200w,
/static/0ee27ac4c33fd4dc2224c18363d91a17/d61c2/sum_chart.png 1800w,
/static/0ee27ac4c33fd4dc2224c18363d91a17/97a96/sum_chart.png 2400w,
/static/0ee27ac4c33fd4dc2224c18363d91a17/d07ca/sum_chart.png 2523w"
        sizes="(max-width: 1200px) 100vw, 1200px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></span>
<p class="css-1ru80hs">Even if the tail pointer is loaded from cache, we still have to pay a 4 cycles cost to fetch from the L1 cache.</p>
<p class="css-1ru80hs">The <strong class="css-zezy6m">Check GC</strong> part of the loop is independent from the rest, and is useful in a multicore context as every domain of the program has to synchronize when performing garbage collection.</p>
<h2 class="css-f9700n">Value speculation</h2>
<p class="css-1ru80hs">It&#x27;s time to open the rune book and perform some dark magic. We know that we
won&#x27;t get past that 4 cycles per iteration bottleneck unless there is a way to
bypass the pointer chasing. To do that, we&#x27;re going to do what was done in
the value speculation article, but in pure OCaml.</p>
<!-- -->
<p class="css-1ru80hs">The principle is the same: <code class="css-ciwx4y">cell</code> is converted to a &quot;pointer&quot; using the forbidden <a href="/static/obj_magic-2d96f4d86cc70e5d70af0612885a2620.jpg"><code class="css-ciwx4y">Obj.magic</code></a> function. Using the value of the <code class="css-ciwx4y">previous</code> list
cell pointer, we can compute <code class="css-ciwx4y">delta</code>, the number of bytes between the two last cells.
This is used to estimate where will be the next cell. If the prediction is correct,
the memory load of the next cell address is effectively bypassed, and the CPU can
directly start working on the next iteration. If not, the branch predictor rolls back the
computation.<!-- --> </p>
<span><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1093px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/b6a2941fbaf286b58431c35c774b74a5/d3f96/seum_delta_1.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 30.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABKElEQVQY03VQa2+DMAzk//+xfdi0rVSqtLLwCGlLgPAmlLTJzaSapk2aJSvW3Tn2Oei6DmVZQimFq55gVw2zTHBGY54GNE3jc55Gz63LQ7PMI9q2RV3XGMcRWzjnEAghcDgcEMcJ2iLDJBkaEUGXMZQU4DwHz3OqT5glYeLoNa3kyKk3iiK/zHcEy7KgJqAfBg9Y9yC2ZzXGi7e83y0sfjhzu+HhroIhne+1FoFeVjx9FAijHOHuzVuIYwYpJRRZfT6e8RpdsA9DFMUFaZpiczX0Hd4/z3hhFXbhHowxDLRUcF0N2KUHL2rwLEPf9/6mLX3cNS1YJpGKiuzl/mYV4aqqMFKd8AKJUOA04Hw6QWuNAP+EI0uOhuFmtmv/IR3sdSXfxNn7L+oL4GHIakLWJrEAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="illustration of the delta computing mechanism "
        title=""
        src="/static/b6a2941fbaf286b58431c35c774b74a5/d3f96/seum_delta_1.png"
        srcset="/static/b6a2941fbaf286b58431c35c774b74a5/5a46d/seum_delta_1.png 300w,
/static/b6a2941fbaf286b58431c35c774b74a5/0a47e/seum_delta_1.png 600w,
/static/b6a2941fbaf286b58431c35c774b74a5/d3f96/seum_delta_1.png 1093w"
        sizes="(max-width: 1093px) 100vw, 1093px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></span>
<pre class="prism-code language-ocaml css-1sg9vzq" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">let</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">rec</span><span class="token plain"> seum </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">previous </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">accu </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cell </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> int list</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">match</span><span class="token plain"> cell </span><span class="token keyword" style="color:rgb(127, 219, 202)">with</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token operator" style="color:rgb(127, 219, 202)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">-&gt;</span><span class="token plain"> accu</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token operator" style="color:rgb(127, 219, 202)">|</span><span class="token plain"> head</span><span class="token punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">tail </span><span class="token operator" style="color:rgb(127, 219, 202)">-&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">let</span><span class="token plain"> current </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> int </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> Obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">magic cell </span><span class="token keyword" style="color:rgb(127, 219, 202)">in</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">(* equivalent to:</span></div><div class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">    let delta = current - previous in</span></div><div class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">    let prediction = current + delta in *)</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">let</span><span class="token plain"> prediction </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> int list </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      Obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">magic </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> current </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain"> previous</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">in</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    seum</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      current</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">accu </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> head</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> prediction </span><span class="token operator" style="color:rgb(127, 219, 202)">==</span><span class="token plain"> tail </span><span class="token keyword" style="color:rgb(127, 219, 202)">then</span><span class="token plain"> prediction </span><span class="token keyword" style="color:rgb(127, 219, 202)">else</span><span class="token plain"> tail</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div></pre>
<pre class="prism-code language-python css-1sg9vzq" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain"> Performance counter stats for &#x27;./a.out seum&#x27;:</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            944,67 msec task-clock:u                     #    1,000 CPUs utilized</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">     3 422 107 884      cycles:u                         #    3,623 GHz</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    16 006 647 403      instructions:u                   #    4,68  insn per cycle</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">     5 001 230 197      branches:u                       #    5,294 G/sec</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">           225 781      branch-misses:u                  #    0,00% of all branches</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div></pre>
<p class="css-1ru80hs">Per iteration:</p>
<ul class="css-zezy6m">
<li class="css-zezy6m">0.94 nanoseconds</li>
<li class="css-zezy6m">3.4 cycles</li>
<li class="css-zezy6m">16 instructions</li>
<li class="css-zezy6m">5 branches</li>
</ul>
<p class="css-1ru80hs">We got past the bottleneck ! What we&#x27;re effectively doing is transforming the list iteration into an array iteration. And this works, because there are situations where OCaml lists are allocated in a linear fashion, making the cell addresses predictible. Note in particular the huge number of instructions per cycle.</p>
<p class="css-1ru80hs">If you are not convinced, here is an updated dependency diagram for this program.</p>
<span><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/0e7c68e5183233304bf79def6aa2b5e5/37d90/seum_chart.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 20%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAABOElEQVQY0w2Qy0rDQBiF58EKgq/iwpXoQqSpigsRfQe7ceXChS1YBRUrIoitl6S5NG2szWUySSYzuTWxRai/szibw+GD76A4jiHPcyemtB0Q0inLslUUxQPG3kqSpKjff0dBGCFCyCkTW5GO53lXjLF2lmW3lNKjqqqQbdtIURSEIhpDmhfPlKdrLiYbjuvVgyCUillZF8AdYzg87HafaubYasaMAWV8y/WDdbHb9ly3ITqJcy4JoCTLsoTmof43j0yoAgNmvgZJND1Ok2h38ZMdVAXfn1jGSe/lfjU0H5sFViH3VEjsD0j90XUQ8c08y/aEYUMYSJqmSShyDGB4vMRfg6Uz+ly4zvcNIX5LHSidXu/1HABQWf4i23w7474FoW3MsSUDno5kccWF6ziXQvVOVdWaruvoHxUNBL4fzwdXAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="seum chart"
        title=""
        src="/static/0e7c68e5183233304bf79def6aa2b5e5/c1b63/seum_chart.png"
        srcset="/static/0e7c68e5183233304bf79def6aa2b5e5/5a46d/seum_chart.png 300w,
/static/0e7c68e5183233304bf79def6aa2b5e5/0a47e/seum_chart.png 600w,
/static/0e7c68e5183233304bf79def6aa2b5e5/c1b63/seum_chart.png 1200w,
/static/0e7c68e5183233304bf79def6aa2b5e5/d61c2/seum_chart.png 1800w,
/static/0e7c68e5183233304bf79def6aa2b5e5/97a96/seum_chart.png 2400w,
/static/0e7c68e5183233304bf79def6aa2b5e5/37d90/seum_chart.png 3003w"
        sizes="(max-width: 1200px) 100vw, 1200px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></span>
<p class="css-1ru80hs">By moving the tail pointer load outside of the critical path, the CPU is able to do more things at once. The following chart shows how one can expect the CPU to execute instructions for three iterations in parallel.</p>
<span><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/33d0488feef08b4620b60d3776e40b59/344cf/seum_chart_tiled.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 41%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAACZElEQVQozx2SyU8TcRiGPxb/Af0TSLx4JvFmYry4JCbejVeUA8ZAuJhIvEokJIZYXIIQClgDtAWqtHShlOlCO9DS0mmZrkNnaaczna4ylM9f/ZLn+rzvm3xQLpexVqv1OOU4jlYUhW+329hoNLBUKr2PJ5L3vJGEcEAn0RmMXa3Z9un1PX/Euh8Jm91HjGmXemqyU0AYgN6l0+mfDMO863a7kMvlQBCE0V4IEftEUVwqFovrqUyhcZ7jUJblOUTsJ/RlE5F+GKWAOj6DhY3d/66hB88BVFUda7dbrzVNmySCVwQzaYqSJM1d6fqTRrP54rebUi0Ob46IoNPpQKuhQeY8BWKBBTqZueGLsgM2T3Bwbds5CCTVQOYZiPgLy7IzPM/HqtUq1jUNSUivKVbKIkoiL7fqtbd6pzVZrUgTaeZsisswd0KxFLjpFFicFCxb7ACXtQr8rVVBrysg8xzkBXlIqWkTqlZ/WbwojSTT7Jg/miqH4ixGklkkE9EXPkWPP4IOik6YPeEZi+fo65LZYfhstBhAiW8ZxWOrsRq3LavJ3ZUWszMvBI3TfHD1oxrdmNbi1tlEaE+l/S48Cbg60YALQ5TTPb/pfmay+0e2D+jxbd/JG+OWa9ywap2AlpzHS43HupTFSpFBTWRR1wTU6wIqpTRK+QSexmgMR8LXwaC/e+jzosvrZbe89I8d3/EiES3Mr5i/L//x3/z2ywZQkJrDchOH86J2N5ws3eb48mxV1ZDQKRQv9EyuqDNZ7vq8IOAZW7gK0DE8DMfsJkfgPnmbx6s276PFTfvDRYvr1tSHT33/APMi5m4eaZULAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="seum chart tiled"
        title=""
        src="/static/33d0488feef08b4620b60d3776e40b59/c1b63/seum_chart_tiled.png"
        srcset="/static/33d0488feef08b4620b60d3776e40b59/5a46d/seum_chart_tiled.png 300w,
/static/33d0488feef08b4620b60d3776e40b59/0a47e/seum_chart_tiled.png 600w,
/static/33d0488feef08b4620b60d3776e40b59/c1b63/seum_chart_tiled.png 1200w,
/static/33d0488feef08b4620b60d3776e40b59/d61c2/seum_chart_tiled.png 1800w,
/static/33d0488feef08b4620b60d3776e40b59/97a96/seum_chart_tiled.png 2400w,
/static/33d0488feef08b4620b60d3776e40b59/344cf/seum_chart_tiled.png 2643w"
        sizes="(max-width: 1200px) 100vw, 1200px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></span>
<style data-emotion="css 3a6syt">.css-3a6syt{color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:20px;}</style><style data-emotion="css v7vzk8">.css-v7vzk8{color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:20px;color:var(--theme-ui-colors-text);font-family:Poppins,sans-serif;line-height:1.25;font-weight:900;font-size:20px;}</style><h3 class="css-v7vzk8">Optimized</h3>
<p class="css-1ru80hs">I was not satisfied by this mere 45% improvement. What if the loop was unrolled, so that the CPU has more freedom to move instructions around ?</p>
<pre class="prism-code language-ocaml css-1sg9vzq" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">let</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">rec</span><span class="token plain"> seum_unroll </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">previous </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">accu </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cell </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> int list</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">match</span><span class="token plain"> cell </span><span class="token keyword" style="color:rgb(127, 219, 202)">with</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token operator" style="color:rgb(127, 219, 202)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">-&gt;</span><span class="token plain"> accu</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token operator" style="color:rgb(127, 219, 202)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">-&gt;</span><span class="token plain">  accu </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> a</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token operator" style="color:rgb(127, 219, 202)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">-&gt;</span><span class="token plain"> accu </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> a </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> b</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token operator" style="color:rgb(127, 219, 202)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">-&gt;</span><span class="token plain"> accu </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> a </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> b </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> c</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token operator" style="color:rgb(127, 219, 202)">|</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">tail </span><span class="token operator" style="color:rgb(127, 219, 202)">-&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">let</span><span class="token plain"> current </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> Obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">magic cell </span><span class="token keyword" style="color:rgb(127, 219, 202)">in</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">let</span><span class="token plain"> prediction </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> int list </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        Obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">magic </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> current </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain"> previous</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">in</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      seum_unroll</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        current</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">accu </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> a </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> b </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> c </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> d</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> prediction </span><span class="token operator" style="color:rgb(127, 219, 202)">==</span><span class="token plain"> tail </span><span class="token keyword" style="color:rgb(127, 219, 202)">then</span><span class="token plain"> prediction </span><span class="token keyword" style="color:rgb(127, 219, 202)">else</span><span class="token plain"> tail</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div></pre>
<p class="css-1ru80hs">The idea is to iterate on the list by chunks of 4 items. There is still the same amount of work to do, but the value prediction trick is performed once every 4 element.</p>
<pre class="prism-code language-python css-1sg9vzq" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain"> Performance counter stats for &#x27;./a.out seum_unroll&#x27;:</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            715,58 msec task-clock:u                     #    0,999 CPUs utilized</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">     2 410 830 333      cycles:u                         #    3,369 GHz</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">     7 756 543 257      instructions:u                   #    3,22  insn per cycle</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">     2 001 229 820      branches:u                       #    2,797 G/sec</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">           112 956      branch-misses:u                  #    0,01% of all branches</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div></pre>
<p class="css-1ru80hs">Per iteration:</p>
<ul class="css-zezy6m">
<li class="css-zezy6m">0.72 nanoseconds</li>
<li class="css-zezy6m">2.4 cycles</li>
<li class="css-zezy6m">7.7 instructions</li>
<li class="css-zezy6m">2 branches</li>
</ul>
<h1 style="font-size:4em;margin-top:-50px;margin-bottom:-50px"><p class="css-1ru80hs"><b>91.3%</b> faster. Nice.</p></h1>
<p class="css-1ru80hs">According the original article, we&#x27;re now faster than the naive C implementation, but 2x slower than the hand-optimized one. This is all very synthetic but I found it quite interesting that OCaml is able to benefit from the same hacks as C. Of course this won&#x27;t be useful in a lot of situations, but maybe one will gain some insights on how modern CPU are able to make programs go fast.</p></div></div></div></main></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/articles/value-speculation-ocaml/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-d97c469be019da6163ec.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-9e510c30c2aa75038774.js\"],\"component---src-pages-articles-tsx\":[\"/component---src-pages-articles-tsx-6d4938919c2b02a7b00b.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-cb18ecbee42e63fddf96.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-20-mirage-and-esp-32-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-20-mirage-and-esp-32-mdx-f96a9f65ac3afff855e9.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-27-last-week-tonight-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-27-last-week-tonight-mdx-4b72104b59cd3cd1d77b.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-28-the-xtensa-architecture-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-03-28-the-xtensa-architecture-mdx-50c7099b5a632f80e284.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-04-27-compiling-and-linking-for-esp-32-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-04-27-compiling-and-linking-for-esp-32-mdx-9f8a2218cba45eb7ca26.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-05-04-success-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-05-04-success-mdx-9cd038eddb542756d381.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-06-22-build-your-own-mirage-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-06-22-build-your-own-mirage-mdx-36034129f1a2178839c4.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-10-02-status-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-10-02-status-mdx-ca1c87152c2fa8ad3fc8.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-10-02-what-now-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2018-10-02-what-now-mdx-226617db739a95684729.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2023-05-05-value-speculation-ocaml-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-articles-2023-05-05-value-speculation-ocaml-mdx-66d1373c6378d366bfa0.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-amogu-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-amogu-mdx-9da4e8693fb5acee9020.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-esp-32-index-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-esp-32-index-mdx-f06cb0b4fc79c9902197.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-mean-field-index-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-mean-field-index-mdx-5b565943f81866559851.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-mirage-4-index-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-mirage-4-index-mdx-756cc66b5dc37f1053b4.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-theoremkb-index-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-theoremkb-index-mdx-631d8fdc7fe15d577636.js\"],\"component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-windos-mdx\":[\"/component---src-pages-mdx-frontmatter-variant-mdx-frontmatter-slug-tsx-content-file-path-src-data-projects-windos-mdx-63c59bdd19103f135243.js\"],\"component---src-pages-photography-tsx\":[\"/component---src-pages-photography-tsx-a03fa3f857230a2d0611.js\"],\"component---src-pages-projects-tsx\":[]}";
          </script>
        <script>window.___webpackCompilationHash="e6f3751ce20f6530e40c";</script><script src="/webpack-runtime-4556567c4495c7c2cbad.js" async></script><script src="/framework-32465eaa607188618171.js" async></script><script src="/app-d97c469be019da6163ec.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>